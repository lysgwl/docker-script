# conf.d/main.conf

# =========================
# 基本 HTTP 配置
# =========================
charset utf-8;						# 默认字符编码
sendfile on;						# 开启高效文件传输
tcp_nopush on;						# 减少网络报文段数量
tcp_nodelay on;						# 提高I/O性能

# =========================
# 超时配置
# =========================
keepalive_timeout 30;				# 连接保持时间
client_header_timeout 15;			# 请求头读取超时
client_body_timeout 15;				# 请求体读取超时
send_timeout 25;					# 响应客户端超时

# =========================
# 客户端限制
# =========================
client_max_body_size 100M;			# 文件上传限制
client_header_buffer_size 4k;		# 请求头缓冲区大小
large_client_header_buffers 4 4k;	# 大请求头缓冲区
#client_body_buffer_size 128k;		# 请求体缓冲区大小

# =========================
# 文件缓存
# =========================
open_file_cache max=1000 inactive=60s; # 打开文件缓存
open_file_cache_valid 30s;			# 缓存验证时间
open_file_cache_min_uses 2;			# 最小使用次数
open_file_cache_errors on;			# 缓存错误信息

# =========================
# DNS解析
# =========================
resolver 127.0.0.11 valid=60s ipv6=off; # Docker内部DNS
resolver_timeout 2s;				# DNS解析超时

# =========================
# 安全配置
# =========================
server_tokens off;					# 隐藏Nginx版本号
autoindex off;						# 禁用目录列表

# =========================
# 安全头部
# =========================
add_header X-Frame-Options SAMEORIGIN;
add_header X-Content-Type-Options nosniff;
#add_header X-XSS-Protection "1; mode=block";	# 已废弃，可移除
add_header Referrer-Policy "strict-origin-when-cross-origin";

# =========================
# 压缩配置
# =========================
gzip on;							# 开启gzip压缩
gzip_vary on;						# 根据Accept-Encoding头变化
gzip_proxied any;					# 对所有代理请求压缩
gzip_comp_level 5;					# 压缩级别（1-9）
gzip_min_length 256;				# 最小压缩长度
#gzip_buffers 16 8k;				# 压缩缓冲区
#gzip_http_version 1.1;				# 压缩HTTP版本
gzip_types 
	text/plain 
	text/css 
	text/xml
	text/javascript
	application/javascript
	application/json 
	application/xml 
	application/xml+rss
	image/svg+xml;

# =========================
# 限流配置
# =========================
limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;	# 限制每个IP的请求速率为每秒10次请求（10r/s）
limit_conn_zone $binary_remote_addr zone=addr:10m;			# 连接数限制

#limit_rate_after 1m;				# 1MB后开始限速
#limit_rate 100k;					# 限制速度为100KB/s

# 启用错误拦截
proxy_intercept_errors on;