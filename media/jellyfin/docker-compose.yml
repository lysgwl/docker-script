
name: jellyfin

services:
  jellyfin-server:
    container_name: jellyfin
    image: nyanmisaka/jellyfin     # nyanmisaka/jellyfin | jellyfin/jellyfin | linuxserver/jellyfin
    devices:
      - /dev/dri:/dev/dri
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - HTTP_PROXY=${PROXY_HOST}
      - HTTPS_PROXY=${PROXY_HOST}
    volumes:
      - ${CONFIG_PATH}:/config
      - ${CACHE_PATH}:/cache
      - ${DATA_PATH}:/data
      - ${NGINX_CONFIG_DIR}:/config/nginx
      - ${NGINX_PROXY_CONF_FILE}:/config/jellyfin.conf
      - nas-films:/media/films
    env_file:
      - .env
    ports:
      - 8096:8096
    privileged: true
    hostname: jellyfin
    networks:
      - local_network
    entrypoint: ["/bin/sh", "-c"]
    command: >
      '
        # 复制配置文件
        if [ -d "/config/nginx/extra/proxy-config" ]; then
            src="/config/jellyfin.conf"
            dst="/config/nginx/extra/proxy-config/jellyfin.conf"
            
            if [ -f "$${src}" ] && [ ! -f "$${dst}" ]; then
                cp -v "$${src}" "$${dst}"
            fi
        fi
        
        # 启动主进程
        exec /jellyfin/jellyfin
      '
    restart: always
      
networks:
  local_network:
    external: true
    
volumes:
  nas-films:
    external: true