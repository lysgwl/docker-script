
name: jellyfin

services:
  jellyfin-server:
    container_name: jellyfin
    image: nyanmisaka/jellyfin:latest     # nyanmisaka/jellyfin | jellyfin/jellyfin | linuxserver/jellyfin
    devices:
      - /dev/dri:/dev/dri
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - HTTP_PROXY=${PROXY_HOST}
      - HTTPS_PROXY=${PROXY_HOST}
      - MOUNT_NAMES=${MOUNT_NAMES}
      - MOUNT_CHECK_INTERVAL=10
      - MOUNT_MAX_FAILURES=3
    volumes:
      - ${DATA_PATH}:/data
      - ${CONFIG_PATH}:/config
      - ${CACHE_PATH}:/cache
      - ${MOUNT_SCRIPTS}:/usr/local/bin/wait-for-mount.sh:ro
      - ${MOUNT_PROBES_DIR}:/var/run/mount-probes:ro
      - /mnt/nas/films:/media/films
    env_file:
      - .env
    ports:
      - 8096:8096
    entrypoint: |
      sh -c "
      echo \"[INFO] 启动阶段：等待挂载点就绪...\"
      
      # 启动时等待挂载点
      wait-for-mount.sh \"${MOUNT_NAMES}\" \"${MOUNT_PATHS}\" --probe-dir /var/run/mount-probes || {
          echo \"[ERROR] 启动等待挂载超时...\"
          exit 1
      }
      
      echo \"[INFO] 挂载点就绪，启动Jellyfin服务\"
      
      # 启动服务
      /jellyfin/jellyfin &
      MAIN_PID=$!
      
      echo \"[INFO] 应用进程的PID: $${MAIN_PID}\"
      
      # 退出信号处理
      shutdown() {
          echo \"[INFO] 收到退出信号, 退出应用服务\"
          
          if kill -0 "$${MAIN_PID}" 2>/dev/null; then
              kill -TERM "$${MAIN_PID}"
              wait "$${MAIN_PID}" 2>/dev/null
          fi
          
          exit 1
      }
      
      # 捕获退出信号
      trap shutdown TERM INT
      
      # 后台监控挂载
      monitor_mounts() {
          # 失败计数
          failures=0
          
          # 初始间隔
          check_interval=${MOUNT_CHECK_INTERVAL:-10} 
          
          while true; do
              sleep $${check_interval}
              
              if wait-for-mount.sh --quick \"$${MOUNT_NAMES}\" \"${MOUNT_PATHS}\" --probe-dir /var/run/mount-probes; then
                  # 检查成功, 重置失败计数
                  if [ "$${failures}" -ne 0 ]; then
                      echo \"[INFO] 挂载点恢复，重置失败计数\"
                  fi
                  
                  failures=0
                  check_interval=60
              else
                  echo \"[WARNING] 挂载点检查失败\"
                  
                  # 累计失败次数
                  failures=$$((failures + 1))
                  echo \"[WARNING] 挂载点失败次数: $${failures}/$${MOUNT_MAX_FAILURES:-3}\"
                  
                  check_interval=10
                  
                  if [ $${failures} -ge $${MOUNT_MAX_FAILURES:-3} ]; then
                      echo \"[ERROR] 挂载点持续失败, 重启容器\"
                      
                      kill -TERM 1
                      break
                  fi
              fi
          done
      }
      
      monitor_mounts &
      
      # 等待应用进程
      wait "$${MAIN_PID}"
      EXIT_CODE=$?
      
      echo \"[INFO] 应用进程退出, 退出码: $${EXIT_CODE}\"
      exit ${EXIT_CODE:-0}
      "
    privileged: true
    hostname: jellyfin
    networks:
      - local_network
    restart: always
      
networks:
  local_network:
    external: true
