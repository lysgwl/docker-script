
name: filesync

services:
  filesync-server:
    container_name: filesync
    image: filesync-image:latest
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - MOUNT_NAMES=${MOUNT_NAMES}
      - MOUNT_CHECK_INTERVAL=30
      - MOUNT_MAX_FAILURES=1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ${FILESYNC_DIR}/data:/data
      - ${FILESYNC_DIR}/config:/config
      - ${FILESYNC_DIR}/usr:/mnt/usr
      - ${DOWNLOADS_DIR}:/mnt/usr/downloads
      - ${MOUNT_SCRIPTS}:/usr/local/bin/wait-for-mount.sh:ro
      - ${MOUNT_PROBES_DIR}:/var/run/mount-probes:ro
      - /mnt/nas/files:/mnt/usr/files
      - /mnt/nas/project:/mnt/usr/project
      - /mnt/nas/images:/mnt/usr/images
      - /mnt/nas/photos:/mnt/usr/photos
      - /mnt/nas/films:/mnt/usr/films
    env_file:
      - .env
    ports:
      - '22000:22000/tcp'   # 文件传输端口映射（TCP）
      - '22000:22000/udp'   # 文件传输端口映射（UDP）
      - '21027:21027/udp'   # 设备发现端口映射（UDP）
    entrypoint: |
      sh -c "
      echo \"[INFO] 启动阶段：等待挂载点就绪...\"
      
      # 启动时等待挂载点
      wait-for-mount.sh \"${MOUNT_NAMES}\" --probe-dir /var/run/mount-probes || {
          echo \"[ERROR] 启动等待挂载超时...\"
          exit 1
      }
      
      echo \"[INFO] 挂载点就绪，启动filesync服务\"
      
      /app/scripts/entrypoint.sh run &
      MAIN_PID=$!
      
      echo \"[INFO] 应用进程的PID: $${MAIN_PID}\"
      
      # 退出信号处理
      shutdown() {
          echo \"[INFO] 收到退出信号, 退出应用服务\"
          
          if kill -0 "$${MAIN_PID}" 2>/dev/null; then
              kill -TERM "$${MAIN_PID}"
              wait "$${MAIN_PID}" 2>/dev/null
          fi
          
          exit 1
      }
      
      # 捕获退出信号
      trap shutdown TERM INT
      
      # 后台监控挂载
      monitor_mounts() {
          # 失败计数
          failures=0
          
          while true; do
              sleep $${MOUNT_CHECK_INTERVAL:-10}
              
              if wait-for-mount.sh --quick \"$${MOUNT_NAMES}\" --probe-dir /var/run/mount-probes; then
                  # 检查成功, 重置失败计数
                  if [ "$${failures}" -ne 0 ]; then
                      echo \"[INFO] 挂载点恢复，重置失败计数\"
                  fi
                  
                  failures=0
              else
                  echo \"[WARNING] 挂载点检查失败\"
                  
                  # 累计失败次数
                  failures=$$((failures + 1))
                  echo \"[WARNING] 挂载点失败次数: $${failures}/$${MOUNT_MAX_FAILURES:-3}\"
                  
                  if [ $${failures} -ge $${MOUNT_MAX_FAILURES:-3} ]; then
                      echo \"[ERROR] 挂载点持续失败, 重启容器\"
                      
                      kill -TERM 1
                      break
                  fi
              fi
          done
      }
      
      monitor_mounts &
      
      # 等待应用进程
      wait "$${MAIN_PID}"
      EXIT_CODE=$?
      
      echo \"[INFO] 应用进程退出, 退出码: $${EXIT_CODE}\"
      exit ${EXIT_CODE:-0}
      "
    hostname: filesync
    networks:
      - local_network
    restart: unless-stopped

networks:
  local_network:
    external: true
